name: 'Terraform EC2 Build Demo'

on:
  push:
    branches:
      - "main"
  pull_request:
  workflow_dispatch:
    inputs:
      terraform-destroy:
        description: 'Destroy EC2 Instances (yes/no)'
        required: true
        default: 'no'

jobs:
  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    environment: development

    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.2

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

        - name: Terraform Format
        id: fmt
        run: terraform fmt -check

        - name: Terraform Init
          id: init
          run: terraform init
        
        - name: Terraform Validate
          id: validate
          run: terraform validate -no-color

        - name: Terraform Plan
          id: plan
          run: terraform plan -no-color -input=false

        # - uses: trstringer/manual-approval@v1
        #   with:
        #       secret: ${{ github.TOKEN }}
        #       approvers: niravshah2705
        #       minimum-approvals: 1
        #       exclude-workflow-initiator-as-approver: false
                    
        - name: Terraform Apply
          run: terraform apply -auto-approve -input=false